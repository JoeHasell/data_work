# Project Background

## Overview
In this project, I am trying to understand the extent and nature of global income inequality based on percentile/quantile data from two different sources: PIP and WID.

The two sources paint different pictures. In particular, published analyses of these sources differ in one important regard: PIP says that the majority of global inequality is due to differences in the average income between countries ('between-country inequality'); WID says that the majority is due to income differences between rich and poor within countries ('within-country inequality'). Because the concepts, methods and raw data used by each source vary in many different ways, it's difficult to know what explains this key difference between PIP and WID. This project is trying to get to the bottom of that.

To do so, it will use the Mean Log Deviation measure of inequality, which is decomposable into between and within country components.

It will create synthetic/alternative distributions based on the original PIP/WID data to explore what the most important factors might be driving this key difference in takeaways concerning global inequality.

## PIP data
The PIP percentile data can be downloaded here:

"https://catalog.ourworldindata.org/garden/wb/2025-10-13/thousand_bins_distribution/thousand_bins_distribution.feather?nocache"

This contains 1000 income 'bins' per country year, each containing 0.1% of the population — as specified in the 'quantile' column.

The 'avg' column gives the average income within that quantile, measured in 2021 international dollars (daily).

The 'pop' column gives the number of people in that quantile.

**IMPORTANT: PIP data is per capita** - income is divided by the total population (adults + children).

## WID data
The WID data is available in the `inputs/` folder.

The structure is different to the PIP data.

Firstly the data is only for a single year, 2023.

Secondly, there are roughly 100 quantile bins — as specified in 'percentile'. 'p0p1' means percentile 1 (the lowest). The exception is that there is higher resolution at the very top of the distribution. (i.e. not all bins are equal sized.)

**CRITICAL DISTINCTION: WID data is per adult** - The 'avg' values represent average income per adult, not per capita. WID takes household income (typically generated by adults) and divides by the number of adults, not total population. To create comparable per capita figures, you need to multiply by adult_pop and divide by total_pop.

The data is spread out across different files:

- **WID_percentiles.csv** (`inputs/WID_percentiles.csv`): Main percentile income data with columns for country, percentile, year, avg income (per adult, in local currency, annual), share, p_low, p_high

- **country_mapping.csv** (`inputs/country_mapping.csv`): Maps WID two-letter country codes to PIP country names

- **WID_aggregate_population.csv** (`inputs/WID_aggregate_population.csv`): Aggregate population data for each country by year. Contains both:
  - **adult_pop**: Adult population (use this for WID per adult calculations)
  - **total_pop**: Total population including children (use this for per capita calculations)

- **WID_ppp.csv** (`inputs/WID_ppp.csv`): PPP conversion factors to convert local currencies to international dollars

The WID income data is given in local currencies (annual) and needs to be:
1. Converted to international dollars using the PPP factors
2. Converted from annual to daily (divide by 365) to match PIP
3. For per capita comparisons: adjusted from per adult to per capita using (avg_per_adult * adult_pop / total_pop)

- **fetch_percentiles_aggs_and_pop.do** (`inputs/fetch_percentiles_aggs_and_pop.do`): This file is just kept here for reference. It is a STATA file which I run (in a different IDE) in order to get the WID data files just described above. It can be ignored.


## Folder Structure

- **inputs/** - Raw data files (WID files are stored here, the PIP data is retreived from a URL as explained above)
- **modified/** - Intermediate processed data files (e.g., harmonized datasets)
- **outputs/** - Final outputs (charts, tables, analysis results)

## Session History

### Session 1 (Feb 6, 2026) - Data Harmonization and Initial Analysis

**Files Created:**
1. `harmonize_percentiles.py` - Main data harmonization script
2. `analyze_inequality.py` - MLD inequality decomposition analysis
3. `pip_wid_harmonized.csv` - Combined harmonized dataset (2.7MB, 45,126 rows)

**Data Harmonization Accomplished:**
- Created script that downloads and processes both PIP and WID data
- Aggregated PIP data from 1000 bins (0.1% each) to 101 bins matching WID structure:
  - P0-P1, P1-P2, ..., P98-P99 (99 bins of 1% each)
  - P99-P99.9 (0.9% of population)
  - P99.9-P100 (top 0.1%)
- Filtered both datasets to 2023 only (WID only has 2023, PIP has multiple years)
- Unified column structure: `country, year, p_low, p_high, pop, average, source`
  - `p_low` and `p_high` are fractions (0-1) indicating percentile boundaries
  - `average` is mean income in 2021 international dollars
  - `source` distinguishes PIP vs WID data
- WID processing includes:
  - Country code mapping to PIP country names
  - Population calculation for each percentile bin
  - Currency conversion from local currency to international dollars using PPP factors

**Dataset Statistics:**
- PIP: 22,018 rows covering 218 countries for 2023
- WID: 23,108 rows covering 211 countries for 2023
- Both use population-weighted averages for income calculations

**Analysis Setup:**
- Created `analyze_inequality.py` to calculate Mean Log Deviation (MLD)
- Decomposes inequality into between-country and within-country components
- Generates stacked bar chart comparing PIP vs WID breakdown
- Analysis was started but not yet completed at end of session

### Session 2 (Feb 7, 2026) - Per Capita vs Per Adult Correction

**Issue Identified:**
- WID data represents income **per adult** (household income divided by adult population)
- PIP data represents income **per capita** (divided by total population including children)
- This fundamental difference was not accounted for in initial analysis

**Files Modified:**
1. `harmonize_percentiles.py` - Updated to create both per adult and per capita versions of WID data
2. `analyze_inequality.py` - Updated to analyze both WID_per_adult and WID_per_capita separately
3. `comparison_plots.py` - Created script for comparing PIP vs WID mean incomes with interactive plots

**New Files Created:**
1. `modified/WID_percentiles_with_per_capita.csv` - WID data with additional per capita average column
2. Updated `modified/pip_wid_harmonized.csv` - Now includes three sources: PIP, WID_per_adult, WID_per_capita

**Key Changes:**
- Calculate WID per capita averages: avg_per_capita = (avg_per_adult * adult_pop) / total_pop
- WID_per_adult uses adult_pop for population figures
- WID_per_capita uses total_pop for population figures
- MLD analysis now compares all three: PIP, WID_per_adult, WID_per_capita
- Visualization shows three bars for complete comparison



